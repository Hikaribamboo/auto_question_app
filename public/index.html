<!DOCTYPE html>
<html>
  <head>
    <title>Google Drive Picker</title>
    <meta charset="utf-8" />
    <script src="https://apis.google.com/js/api.js"></script>
  </head>
  <body>
    <h1>Google Drive Picker Demo</h1>
    <button id="pick-file" style="display:none;">Pick a File</button>
    <div id="file-info"></div>

    <script>
      let pickerApiLoaded = false;
      let oauthToken;

      async function fetchEnvVariables() {
        try {
          const response = await fetch('/env');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Failed to fetch environment variables:", error);
          return null;
        }
      }

      async function onApiLoad() {
        const envVariables = await fetchEnvVariables();
        if (!envVariables) {
          console.error("Environment variables not fetched.");
          return;
        }

        const { clientId, apiKey } = envVariables;

        if (!clientId || !apiKey) {
          console.error("Client ID or API Key is missing");
          return;
        }

        gapi.load('auth', () => onAuthApiLoad(clientId));
        gapi.load('picker', onPickerApiLoad);
      }

      function onPickerApiLoad() {
        pickerApiLoaded = true;
      }

      function onAuthApiLoad(clientId) {
        gapi.auth.authorize(
          {
            client_id: clientId,
            scope: ['https://www.googleapis.com/auth/drive.file'],
            immediate: false,
          },
          handleAuthResult
        );
      }

      function handleAuthResult(authResult) {
        if (authResult && !authResult.error) {
          oauthToken = authResult.access_token;
          document.getElementById('pick-file').style.display = 'block';
        }
      }

      async function createPicker() {
        const { apiKey } = await fetchEnvVariables();

        if (!pickerApiLoaded) {
          console.error("Picker API is not loaded yet.");
          return;
        }

        if (oauthToken) {
          const picker = new google.picker.PickerBuilder()
            .addView(google.picker.ViewId.DOCS)
            .setOAuthToken(oauthToken)
            .setDeveloperKey(apiKey)
            .setCallback(pickerCallback)
            .build();
          picker.setVisible(true);
        } else {
          console.error("OAuth Token is not available.");
        }
      }

      function pickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
          const file = data.docs[0];
          document.getElementById('file-info').innerText = `Selected file: ${file.name} (${file.id})`;
          console.log(`File ID: ${file.id}, File Name: ${file.name}`);
        }
      }

      document.getElementById('pick-file').addEventListener('click', createPicker);

      gapi.load('client:auth2', onApiLoad);
    </script>
  </body>
</html>
