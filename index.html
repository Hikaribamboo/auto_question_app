import express from "express";
import path from "path";
import dotenv from "dotenv";

dotenv.config();

const app = express();
const PORT = 8000;

// 環境変数をHTMLファイルに注入するエンドポイント
app.get("/", (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
      <head>
        <title>Google Drive Picker</title>
        <meta charset="utf-8" />
        <script src="https://apis.google.com/js/api.js"></script>
      </head>
      <body>
        <h1>Google Drive Picker Demo</h1>
        <button id="pick-file">Pick a File</button>
        <div id="file-info"></div>

        <script>
          let pickerApiLoaded = false;
          let oauthToken;

          function onApiLoad() {
            gapi.load('auth', onAuthApiLoad);
            gapi.load('picker', onPickerApiLoad);
          }

          function onPickerApiLoad() {
            pickerApiLoaded = true;
          }

          function onAuthApiLoad() {
            gapi.auth.authorize(
              {
                client_id: '${process.env.CLIENT_ID}', // 環境変数を挿入
                scope: ['https://www.googleapis.com/auth/drive.file'],
                immediate: false,
              },
              handleAuthResult
            );
          }

          function handleAuthResult(authResult) {
            if (authResult && !authResult.error) {
              oauthToken = authResult.access_token;
              document.getElementById('pick-file').style.display = 'block';
            }
          }

          function createPicker() {
            if (pickerApiLoaded && oauthToken) {
              const picker = new google.picker.PickerBuilder()
                .addView(google.picker.ViewId.DOCS)
                .setOAuthToken(oauthToken)
                .setDeveloperKey('${process.env.API_KEY}') // 環境変数を挿入
                .setCallback(pickerCallback)
                .build();
              picker.setVisible(true);
            }
          }

          function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
              const file = data.docs[0];
              document.getElementById('file-info').innerText = `Selected file: ${file.name} (${file.id})`;
              console.log(`File ID: ${file.id}, File Name: ${file.name}`);

            }
          }

          document.getElementById('pick-file').addEventListener('click', createPicker);
          gapi.load('client:auth2', onApiLoad);
        </script>
      </body>
    </html>
  `);
});

// サーバーを起動
app.listen(PORT, () => console.log(`Server is running at http://localhost:${PORT}`));

